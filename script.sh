#! /usr/bin/bash

# Automated forensic script for cve-2019-19781
# Author : onSec-fr : https://github.com/onSec-fr/
# Release date : 13.01.2020

if [[ $# -eq 0 ]] ; then
    echo -e 'Please specify output file name'
    exit 1
fi

echo -e 'WORKING...'

echo -e '\n====================XML TEMP FILES====================\n' >> $1 2> /dev/null
echo -e '#List temp xml template files created by user nobody (likely an attacker)'>> $1
ls -rtal /var/tmp/netscaler/portal/templates/*.ttc2 | grep nobody >> $1 2> /dev/null
echo -e '\n=========================CMD==========================\n' >> $1 2> /dev/null
echo -e '#Traces of commands issued by xml templates'>> $1
for i in $(ls -rt /var/tmp/netscaler/portal/templates/*.ttc2); do grep -o '`.*`' --no-filename $i | sed 's/`//g'; done >> $1 2> /dev/null
echo -e '\n=======================XML FILES======================\n' >> $1 2> /dev/null
echo -e '#List temp xml template files created by user nobody (likely an attacker)'>> $1
ls -rtal /netscaler/portal/templates/*.xml | grep nobody >> $1 2> /dev/null
echo -e '\n=========================CMD==========================\n' >> $1 2> /dev/null
echo -e '#Results of commands issued by the attacker via xml templates.'>> $1
for i in $(ls -rt /netscaler/portal/templates/*.xml); do cat $i ; echo -e '-----------------------------------------' ; done >> $1 2> /dev/null
echo -e '\n=======================PROCESS========================\n' >> $1 2> /dev/null
echo -e '#List of process of user nobody. Should only contains httpd service'>> $1
ps auxd | awk '$1 == "nobody"' >> $1 2> /dev/null
echo -e '\n=======================CRONTAB========================\n' >> $1 2> /dev/null
echo -e '#List of scheduled jobs created by user nobody (likely used for persistence)'>> $1
crontab -l -u nobody >> $1 2> /dev/null
echo -e '\n=======================WEB LOGS=======================\n' >> $1 2> /dev/null
echo -e '#Apache logs for path traversal attack on /vpn/'>> $1
mkdir /var/log/temp/ 
cp -a /var/log/httpaccess*gz /var/log/temp/ 2> /dev/null
cp /var/log/httpaccess.log /var/log/temp/ 2> /dev/null
gzip -d /var/log/temp/*
cat /var/log/temp/* | grep 'vpn/../' >> $1 2> /dev/null
rm -rf /var/log/temp/

echo -e 'DONE!'